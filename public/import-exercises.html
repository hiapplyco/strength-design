<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Exercises to Firestore</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    button {
      background: #FF6B35;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #e55a2b;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .progress {
      margin: 20px 0;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 5px;
      display: none;
    }
    .progress.active {
      display: block;
    }
    .stats {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 5px;
      display: none;
    }
    .stats.active {
      display: block;
    }
    .error {
      color: #d32f2f;
      margin: 10px 0;
    }
    .success {
      color: #388e3c;
      margin: 10px 0;
    }
    .log {
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Import Wrkout Exercises to Firestore</h1>
    
    <div>
      <button id="loadBtn">Load Exercises JSON</button>
      <button id="importBtn" disabled>Import to Firestore</button>
      <button id="clearBtn">Clear Existing Exercises</button>
    </div>
    
    <div id="progress" class="progress">
      <div id="progressText">Loading...</div>
      <div id="progressBar"></div>
    </div>
    
    <div id="stats" class="stats">
      <h3>Import Statistics</h3>
      <div id="statsContent"></div>
    </div>
    
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      doc, 
      setDoc, 
      getDocs, 
      deleteDoc,
      writeBatch 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDJI0yWNRkJiWCqYQZKuAe_1FUCqBvhYTU",
      authDomain: "strength-design.firebaseapp.com",
      projectId: "strength-design",
      storageBucket: "strength-design.appspot.com",
      messagingSenderId: "507103061700",
      appId: "1:507103061700:web:5ab13c3b8e8c5a1c9e7e8c"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let exercises = [];
    const logDiv = document.getElementById('log');
    const progressDiv = document.getElementById('progress');
    const progressText = document.getElementById('progressText');
    const statsDiv = document.getElementById('stats');
    const statsContent = document.getElementById('statsContent');
    
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    // Load exercises from JSON
    document.getElementById('loadBtn').addEventListener('click', async () => {
      try {
        progressDiv.classList.add('active');
        progressText.textContent = 'Loading exercises JSON...';
        
        const response = await fetch('/wrkout-exercises-full.json');
        if (!response.ok) throw new Error('Failed to load exercises JSON');
        
        exercises = await response.json();
        
        log(`Loaded ${exercises.length} exercises from JSON`, 'success');
        progressDiv.classList.remove('active');
        
        document.getElementById('importBtn').disabled = false;
        document.getElementById('loadBtn').disabled = true;
        
      } catch (error) {
        log(`Error loading exercises: ${error.message}`, 'error');
        progressDiv.classList.remove('active');
      }
    });
    
    // Import exercises to Firestore
    document.getElementById('importBtn').addEventListener('click', async () => {
      if (exercises.length === 0) {
        log('No exercises to import', 'error');
        return;
      }
      
      const confirmImport = confirm(`Import ${exercises.length} exercises to Firestore?`);
      if (!confirmImport) return;
      
      progressDiv.classList.add('active');
      document.getElementById('importBtn').disabled = true;
      
      let successCount = 0;
      let failCount = 0;
      const batchSize = 100;
      
      try {
        for (let i = 0; i < exercises.length; i += batchSize) {
          const batch = writeBatch(db);
          const currentBatch = exercises.slice(i, Math.min(i + batchSize, exercises.length));
          
          for (const exercise of currentBatch) {
            const docRef = doc(db, 'exercises', exercise.id);
            batch.set(docRef, {
              ...exercise,
              createdAt: new Date(),
              updatedAt: new Date()
            });
          }
          
          await batch.commit();
          successCount += currentBatch.length;
          
          progressText.textContent = `Importing... ${successCount}/${exercises.length}`;
          log(`Batch ${Math.floor(i/batchSize) + 1} committed (${currentBatch.length} exercises)`);
          
          // Small delay between batches
          if (i + batchSize < exercises.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        log(`‚úÖ Import complete! ${successCount} exercises imported`, 'success');
        
        statsDiv.classList.add('active');
        statsContent.innerHTML = `
          <p>‚úÖ Successfully imported: <strong>${successCount}</strong> exercises</p>
          <p>‚ùå Failed: <strong>${failCount}</strong> exercises</p>
          <p>üìä Total in database: <strong>${successCount}</strong> exercises</p>
        `;
        
      } catch (error) {
        log(`Error during import: ${error.message}`, 'error');
        failCount++;
      } finally {
        progressDiv.classList.remove('active');
      }
    });
    
    // Clear existing exercises
    document.getElementById('clearBtn').addEventListener('click', async () => {
      const confirmClear = confirm('Are you sure you want to delete all exercises from Firestore?');
      if (!confirmClear) return;
      
      progressDiv.classList.add('active');
      progressText.textContent = 'Deleting existing exercises...';
      
      try {
        const querySnapshot = await getDocs(collection(db, 'exercises'));
        let deleteCount = 0;
        
        const batchSize = 100;
        let batch = writeBatch(db);
        let batchCount = 0;
        
        for (const docSnapshot of querySnapshot.docs) {
          batch.delete(docSnapshot.ref);
          batchCount++;
          deleteCount++;
          
          if (batchCount >= batchSize) {
            await batch.commit();
            log(`Deleted batch of ${batchCount} exercises`);
            batch = writeBatch(db);
            batchCount = 0;
          }
        }
        
        if (batchCount > 0) {
          await batch.commit();
        }
        
        log(`‚úÖ Deleted ${deleteCount} exercises`, 'success');
        
      } catch (error) {
        log(`Error clearing exercises: ${error.message}`, 'error');
      } finally {
        progressDiv.classList.remove('active');
      }
    });
    
    // Check current status on load
    window.addEventListener('load', async () => {
      try {
        const querySnapshot = await getDocs(collection(db, 'exercises'));
        log(`Current database has ${querySnapshot.size} exercises`);
      } catch (error) {
        log(`Error checking database: ${error.message}`, 'error');
      }
    });
  </script>
</body>
</html>